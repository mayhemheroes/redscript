on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      suffix:
        required: true
        type: string
      tag:
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ${{ inputs.os }}
    env:
      ARCHIVE_NAME: redscript-${{ inputs.tag }}-${{ inputs.suffix }}.zip
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0

      - run: rustup toolchain install stable --profile minimal --no-self-update
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ inputs.os }}
      - run: cargo build --release

      - if: runner.os == 'Windows'
        run: .\scripts\package.ps1 -archiveName "${{ env.ARCHIVE_NAME }}"
      - if: runner.os != 'Windows'
        run: ./scripts/package.sh "${{ env.ARCHIVE_NAME }}"

      - uses: actions/upload-artifact@v4
        name: Upload artifacts
        with:
          path: |
            redscript-cli.exe
            redscript-cli-aarch64-darwin
            redscript-cli-x86_64-linux-gnu
            ${{ env.ARCHIVE_NAME }}
          name: artifact-${{ inputs.os }}
          if-no-files-found: error
