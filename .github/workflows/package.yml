on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      suffix:
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ${{ inputs.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0
      - run: rustup toolchain install stable --profile minimal --no-self-update
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ inputs.os }}
      - run: cargo build --release
      - id: tag
        run: echo "tag=$(git describe --tags $(git rev-list --tags --max-count=1))" >> $env:GITHUB_OUTPUT
      - if: ${{ inputs.os == 'windows-latest' }}
        run: |
          $tag=$(git describe --tags $(git rev-list --tags --max-count=1))
          .\scripts\package.ps1 -archiveName "redscript-$tag-${{ inputs.suffix }}.zip"
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
      - if: ${{ inputs.os != 'windows-latest' }}
        run: |
          tag=$(git describe --tags $(git rev-list --tags --max-count=1))
          ./scripts/package.sh "redscript-$tag-${{ inputs.suffix }}.zip"
          echo "tag=$tag" >> $GITHUB_OUTPUT
      - uses: actions/upload-artifact@v4
        name: Upload artifacts
        with:
          path: |
            redscript-cli.exe
            redscript-cli-aarch64-darwin
            redscript-cli-x86_64-linux-gnu
            redscript-${{ steps.tag.outputs.tag }}-${{ inputs.suffix }}.zip
          if-no-files-found: error
